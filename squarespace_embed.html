<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Johnny Â· Realtime Voice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Link to the backend-hosted assets -->
    <link rel="stylesheet" href="https://my-backend-api.onrender.com/voice-widget.css">
    <style>
        /* Minimal Page Context for the Widget Demo */
        body {
            margin: 0;
            height: 100vh;
            background: radial-gradient(ellipse at center, #1b2735 0%, #090a0f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .welcome-text {
            text-align: center;
            animation: fadeIn 2s ease;
        }

        h1 {
            font-weight: 900;
            font-size: 3rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #00d4ff, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p {
            color: #64748b;
            font-size: 1.1rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="welcome-text">
        <h1>JOHNNY</h1>
        <p>Realtime Voice-to-Voice Agent</p>
    </div>

    <!-- The actual widget will be injected by the script -->
    <script src="https://my-backend-api.onrender.com/voice-widget.js"></script>
</body>

</html>

@keyframes modalSlide {
from {
opacity: 0;
transform: translateY(20px) scale(0.97);
}

to {
opacity: 1;
transform: translateY(0) scale(1);
}
}

.growgrid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 14px;
}

@media (max-width: 900px) {
.growgrid {
grid-template-columns: 1fr;
}
}

.group {
border: 1px solid var(--panelBorder);
border-radius: 16px;
padding: 14px;
background: rgba(255, 255, 255, 0.6);
transition: all 0.2s var(--ease-out);
}

.group:hover {
background: rgba(255, 255, 255, 0.8);
box-shadow: var(--shadow-sm);
}

.group h4 {
margin: 0 0 10px 0;
font-size: 0.8rem;
font-weight: 800;
text-transform: uppercase;
letter-spacing: 0.05em;
color: var(--text-muted);
}

.pills {
display: flex;
flex-wrap: wrap;
gap: 8px;
}

.pill {
padding: 8px 14px;
border-radius: 999px;
border: 1px solid rgba(148, 163, 184, 0.3);
background: rgba(255, 255, 255, 0.8);
color: var(--text);
font-family: inherit;
font-size: 0.85rem;
font-weight: 500;
cursor: pointer;
transition: all 0.2s var(--ease-out);
}

.pill:hover {
border-color: var(--neon-purple);
background: rgba(139, 92, 246, 0.08);
}

.pill.active {
background: var(--gradient-primary);
border-color: transparent;
color: #fff;
font-weight: 600;
box-shadow: 0 2px 12px rgba(139, 92, 246, 0.25);
}

.builder-actions {
display: flex;
gap: 12px;
justify-content: flex-end;
margin-top: 16px;
}

#builderNotes {
width: 100%;
min-height: 100px;
border: 1px solid rgba(148, 163, 184, 0.3);
border-radius: 14px;
padding: 14px;
background: rgba(255, 255, 255, 0.8);
color: var(--text);
font-family: inherit;
font-size: 0.9rem;
resize: vertical;
transition: all 0.25s var(--ease-out);
}

#builderNotes:focus {
outline: none;
border-color: var(--neon-purple);
background: #fff;
box-shadow:
0 0 0 4px rgba(139, 92, 246, 0.1),
0 4px 20px rgba(139, 92, 246, 0.08);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
THINKING ANIMATION (Digital Wave)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.think {
display: inline-flex;
align-items: center;
gap: 12px;
padding: 6px 0;
}

.wave {
display: flex;
align-items: center;
gap: 3px;
height: 20px;
}

.wave span {
display: block;
width: 4px;
height: 100%;
background: var(--gradient-primary);
border-radius: 99px;
animation: wave 1s ease-in-out infinite;
}

.wave span:nth-child(2) {
animation-delay: 0.1s;
}

.wave span:nth-child(3) {
animation-delay: 0.2s;
}

@keyframes wave {

0%,
100% {
height: 6px;
opacity: 0.5;
}

50% {
height: 20px;
opacity: 1;
}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
QUOTA MODAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.quota {
position: fixed;
inset: 0;
background: rgba(10, 13, 30, 0.75);
backdrop-filter: blur(16px);
display: none;
align-items: center;
justify-content: center;
z-index: 9999;
}

.quota.show {
display: flex;
}

.quota-card {
width: min(560px, 92vw);
border-radius: 24px;
background: var(--glass-bg-strong);
backdrop-filter: blur(20px);
border: 1px solid var(--glass-border);
box-shadow: var(--shadow-lg);
padding: 28px;
animation: modalSlide 0.35s var(--ease-out);
}

.q-title {
font-weight: 900;
font-size: 1.25rem;
margin-bottom: 8px;
background: var(--gradient-primary);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.q-note {
margin: 12px 0 18px;
color: var(--text-muted);
line-height: 1.6;
}

.q-badge {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 8px 14px;
border-radius: 999px;
background: var(--gradient-primary);
color: #fff;
font-weight: 800;
font-size: 0.9rem;
box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.q-actions {
display: flex;
gap: 12px;
justify-content: flex-end;
margin-top: 16px;
}

.pulse {
animation: pulse 1.2s ease-in-out 2;
}

@keyframes pulse {
0% {
box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.6);
}

100% {
box-shadow: 0 0 0 16px rgba(139, 92, 246, 0);
}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CUSTOM SCROLLBARS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar {
width: 8px;
height: 8px;
}

::-webkit-scrollbar-track {
background: transparent;
}

::-webkit-scrollbar-thumb {
background: linear-gradient(180deg, var(--neon-cyan), var(--neon-purple));
border-radius: 10px;
border: 2px solid transparent;
background-clip: padding-box;
}

::-webkit-scrollbar-thumb:hover {
background: linear-gradient(180deg, var(--neon-purple), var(--neon-pink));
background-clip: padding-box;
}

/* Firefox */
* {
scrollbar-width: thin;
scrollbar-color: var(--neon-purple) transparent;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
UTILITY & MISC
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.muted {
color: var(--text-muted);
font-size: 0.875rem;
}

input[type="checkbox"] {
width: 18px;
height: 18px;
accent-color: var(--neon-purple);
cursor: pointer;
}

input[type="file"] {
font-family: inherit;
font-size: 0.875rem;
color: var(--text-muted);
}

input[type="file"]::file-selector-button {
padding: 8px 14px;
border-radius: 10px;
border: 1px solid var(--panelBorder);
background: rgba(255, 255, 255, 0.8);
color: var(--text);
font-family: inherit;
font-weight: 600;
cursor: pointer;
margin-right: 12px;
transition: all 0.2s var(--ease-out);
}

input[type="file"]::file-selector-button:hover {
background: var(--neon-purple);
color: #fff;
border-color: var(--neon-purple);
}

select.field {
cursor: pointer;
appearance: none;
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0
12 12'%3E%3Cpath fill='%2364748b' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
background-repeat: no-repeat;
background-position: right 12px center;
padding-right: 36px;
}

/* Label text styling */
[style*="font-weight:800"],
[style*="font-weight:700"] {
letter-spacing: 0.01em;
}

/* Smooth transitions for interactive elements */
a,
button,
input,
textarea,
select {
transition: all 0.2s var(--ease-out);
}

/* Focus visible for accessibility */
:focus-visible {
outline: 2px solid var(--neon-purple);
outline-offset: 2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MOBILE-FIRST RESPONSIVE DESIGN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Hamburger Menu Button */
.hamburger {
display: none;
width: 44px;
height: 44px;
border-radius: 12px;
border: 1px solid var(--panelBorder);
background: var(--glass-bg);
backdrop-filter: blur(10px);
cursor: pointer;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 5px;
padding: 10px;
transition: all 0.2s var(--ease-out);
}

.hamburger span {
display: block;
width: 20px;
height: 2px;
background: var(--text);
border-radius: 2px;
transition: all 0.3s var(--ease-out);
}

.hamburger:hover {
background: var(--neon-purple);
border-color: var(--neon-purple);
}

.hamburger:hover span {
background: #fff;
}

.hamburger.active span:nth-child(1) {
transform: rotate(45deg) translate(5px, 5px);
}

.hamburger.active span:nth-child(2) {
opacity: 0;
}

.hamburger.active span:nth-child(3) {
transform: rotate(-45deg) translate(5px, -5px);
}

/* Mobile Header */
.mobile-header {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
z-index: 100;
padding: 12px 16px;
background: var(--glass-bg-strong);
backdrop-filter: blur(24px);
border-bottom: 1px solid var(--panelBorder);
align-items: center;
justify-content: space-between;
}

.mobile-header .brand {
font-weight: 900;
font-size: 1.1rem;
background: var(--gradient-primary);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

/* Sidebar Overlay */
.sidebar-overlay {
display: none;
position: fixed;
inset: 0;
background: rgba(10, 13, 30, 0.5);
backdrop-filter: blur(4px);
z-index: 200;
opacity: 0;
transition: opacity 0.3s var(--ease-out);
}

.sidebar-overlay.show {
opacity: 1;
}

/* Attachment Button & Preview */
.attach-btn {
width: 44px;
height: 44px;
min-width: 44px;
border-radius: 12px;
border: 1px solid var(--panelBorder);
background: var(--glass-bg);
color: var(--text-muted);
font-size: 20px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s var(--ease-out);
}

.attach-btn:hover {
background: var(--neon-purple);
color: #fff;
border-color: var(--neon-purple);
}

.attachment-preview {
display: none;
flex-wrap: wrap;
gap: 8px;
padding: 10px 14px 0;
border-top: 1px solid var(--panelBorder);
margin-bottom: -1px;
background: rgba(248, 250, 255, 0.4);
}

.attachment-preview.has-files {
display: flex;
}

.attachment-item {
position: relative;
width: 60px;
height: 60px;
border-radius: 10px;
overflow: hidden;
border: 2px solid var(--panelBorder);
background: #fff;
}

.attachment-item img {
width: 100%;
height: 100%;
object-fit: cover;
}

.attachment-item .pdf-icon {
display: flex;
align-items: center;
justify-content: center;
width: 100%;
height: 100%;
font-size: 10px;
font-weight: 800;
color: var(--text-muted);
background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(0, 212, 255, 0.08));
}

.attachment-item .remove-attach {
position: absolute;
top: -4px;
right: -4px;
width: 20px;
height: 20px;
border-radius: 50%;
border: none;
background: var(--gradient-danger);
color: #fff;
font-size: 12px;
font-weight: 900;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
}

/* Inline Image Bubble */
.bubble-image {
max-width: 100%;
border-radius: 12px;
margin-top: 8px;
cursor: pointer;
transition: transform 0.3s var(--ease-out);
}

.bubble-image:hover {
transform: scale(1.02);
}

/* Image Generate Indicator */
.generating-indicator {
display: inline-flex;
align-items: center;
gap: 10px;
padding: 12px 16px;
background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(0, 212, 255, 0.08));
border-radius: 12px;
margin-top: 8px;
}

.generating-indicator .orbit {
width: 20px;
height: 20px;
}

/* Command hint */
.command-hint {
position: absolute;
bottom: 100%;
left: 14px;
padding: 6px 12px;
background: var(--glass-bg-strong);
backdrop-filter: blur(10px);
border: 1px solid var(--panelBorder);
border-radius: 10px;
font-size: 0.8rem;
color: var(--text-muted);
margin-bottom: 8px;
opacity: 0;
transform: translateY(10px);
transition: all 0.2s var(--ease-out);
pointer-events: none;
box-shadow: var(--shadow-sm);
}

.command-hint.show {
opacity: 1;
transform: translateY(0);
}

.command-hint code {
background: rgba(139, 92, 246, 0.15);
padding: 2px 6px;
border-radius: 4px;
color: var(--neon-purple);
font-weight: 600;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MOBILE BREAKPOINT (768px and below)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {

/* Mobile header hidden in favor of stacked layout */
.mobile-header {
display: none;
}

.hamburger {
display: none;
}

.sidebar-overlay {
display: none;
}

/* Full width layout, stacked, minimal padding to prevent cutoff */
.layout {
grid-template-columns: 1fr;
padding: 4px;
padding-top: 10px;
display: grid;
gap: 12px;
width: 100%;
overflow-x: hidden;
}

/* Sidebar underneath */
#sidebar {
position: relative;
top: auto;
left: auto;
bottom: auto;
width: 100%;
max-width: 100%;
z-index: 1;
border-radius: 20px;
transform: none;
order: 2;
}

/* Main chat on top */
#main {
width: 100%;
padding: 0;
order: 1;
}

/* Ensure sidebar is visible */
#sidebar.open {
transform: none;
}

#sidebar.open {
transform: translateX(0);
}

/* Main takes full width */
#main {
width: 100%;
padding: 8px;
}

/* Card adjustments */
.card {
border-radius: 16px;
border: none;
box-shadow: none;
background: transparent;
backdrop-filter: none;
}

/* Stack to single column */
.stack {
grid-template-columns: 1fr;
gap: 8px;
padding: 0;
}

/* Hide docs panel - functionality moved to chat */
.docs-panel {
display: none !important;
}

/* Chat panel full width */
.panel {
border: none;
border-radius: 0;
background: transparent;
backdrop-filter: none;
padding: 0;
}

/* Chat container */
.chat {
height: calc(100vh - 80px);
min-height: auto;
border-radius: 16px;
border: 1px solid var(--panelBorder);
background: var(--glass-bg-strong);
backdrop-filter: blur(20px);
}

/* New chat via hamburger menu on mobile */

/* Messages area */
.messages {
padding: 12px 8px;
}

/* Wider bubbles on mobile */
.bubble {
max-width: 92%;
padding: 12px 14px;
border-radius: 16px;
}

/* Composer adjustments */
.composer {
padding: 10px 12px;
gap: 8px;
background: rgba(255, 255, 255, 0.9);
border-radius: 0 0 16px 16px;
}

/* Textarea grows more */
textarea {
min-height: 44px;
padding: 10px 14px;
border-radius: 12px;
font-size: 16px;
/* Prevents iOS zoom */
}

/* Send button */
.composer .btn {
height: 44px;
padding: 0 16px;
min-width: 70px;
}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SMALL MOBILE (480px and below)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 480px) {
.mobile-header {
padding: 10px 12px;
}

.layout {
padding-top: 10px;
}

.bubble {
max-width: 95%;
font-size: 0.95rem;
}

.attachment-item {
width: 50px;
height: 50px;
}

.composer .btn {
padding: 0 12px;
min-width: 60px;
}

/* Recent images grid */
.imggrid {
grid-template-columns: repeat(4, 1fr);
}
}

/* Container for the Holographic Loader */
.image-loader {
position: relative;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 30px 40px;
background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(20, 20, 40, 0.9) 100%);
border-radius: 16px;
margin: 15px 0;
border: 2px solid transparent;
background-clip: padding-box;
overflow: hidden;
font-family: 'Inter', sans-serif;
/* Adjust font as needed */
}

/* Animated Holographic Border */
.image-loader::before {
content: '';
position: absolute;
inset: -2px;
background: linear-gradient(45deg, #00f7ff, #ff00ff, #00f7ff, #ff00ff);
background-size: 400% 400%;
animation: gradient-spin 3s linear infinite;
border-radius: 18px;
z-index: -1;
}

/* Inner Glow/Pulse */
.image-loader::after {
content: '';
position: absolute;
inset: 0;
background: radial-gradient(circle at 50% 50%, rgba(0, 247, 255, 0.1) 0%, transparent 70%);
animation: pulse-glow 2s ease-in-out infinite;
pointer-events: none;
}

/* Central Orb Container */
.neural-orb {
position: relative;
width: 80px;
height: 80px;
margin-bottom: 15px;
}

/* Spinning Ring around Orb */
.neural-orb::before {
content: '';
position: absolute;
inset: 0;
border-radius: 50%;
background: conic-gradient(from 0deg, #00f7ff, #ff00ff, #00ff88, #ff00ff, #00f7ff);
animation: orb-spin 2s linear infinite;
filter: blur(2px);
}

/* The Core of the Orb (with Icon) */
.neural-orb::after {
content: 'ğŸ¨';
/* You can change this icon */
position: absolute;
inset: 8px;
background: radial-gradient(circle, #1a1a2e 0%, #0f0f1a 100%);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 28px;
animation: orb-pulse 1.5s ease-in-out infinite;
}

/* Text Styling */
.loader-text {
font-family: 'Courier New', monospace;
/* Tech feel font */
font-size: 0.9em;
color: #fff;
text-transform: uppercase;
letter-spacing: 3px;
text-shadow: 0 0 20px #00f7ff, 0 0 40px #ff00ff;
animation: text-flicker 2s ease-in-out infinite;
z-index: 1;
}

.loader-subtext {
font-size: 0.75em;
color: rgba(255, 255, 255, 0.6);
margin-top: 8px;
z-index: 1;
}

/* Floating Particles Effect */
.loader-particles {
position: absolute;
width: 100%;
height: 100%;
overflow: hidden;
pointer-events: none;
}

.loader-particles span {
position: absolute;
width: 4px;
height: 4px;
background: #00f7ff;
border-radius: 50%;
animation: float-up 3s ease-in-out infinite;
box-shadow: 0 0 10px #00f7ff;
bottom: -10px;
opacity: 0;
}

/* Particle Positions & Delays */
.loader-particles span:nth-child(1) {
left: 10%;
animation-delay: 0s;
}

.loader-particles span:nth-child(2) {
left: 30%;
animation-delay: 0.5s;
background: #ff00ff;
box-shadow: 0 0 10px #ff00ff;
}

.loader-particles span:nth-child(3) {
left: 50%;
animation-delay: 1s;
}

.loader-particles span:nth-child(4) {
left: 70%;
animation-delay: 1.5s;
background: #00ff88;
box-shadow: 0 0 10px #00ff88;
}

.loader-particles span:nth-child(5) {
left: 90%;
animation-delay: 2s;
background: #ff00ff;
box-shadow: 0 0 10px #ff00ff;
}

/* Keyframe Animations */
@keyframes gradient-spin {
0% {
background-position: 0% 50%;
}

50% {
background-position: 100% 50%;
}

100% {
background-position: 0% 50%;
}
}

@keyframes pulse-glow {

0%,
100% {
opacity: 0.3;
transform: scale(1);
}

50% {
opacity: 0.8;
transform: scale(1.05);
}
}

@keyframes orb-spin {
from {
transform: rotate(0deg);
}

to {
transform: rotate(360deg);
}
}

@keyframes orb-pulse {

0%,
100% {
transform: scale(1);
}

50% {
transform: scale(1.1);
}
}

@keyframes text-flicker {

0%,
100% {
opacity: 1;
}

50% {
opacity: 0.8;
}

52% {
opacity: 1;
}

54% {
opacity: 0.9;
}
}

@keyframes float-up {
0% {
bottom: -10px;
opacity: 0;
}

20% {
opacity: 1;
}

80% {
opacity: 1;
}

100% {
bottom: 100%;
opacity: 0;
}
}
</style>
</head>

<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button id="hamburger" class="hamburger" aria-label="Menu">
            <span></span><span></span><span></span>
        </button>
        <div class="brand">Johnny Chat</div>
        <div style="width:44px"></div> <!-- Spacer for balance -->
    </div>

    <!-- Sidebar Overlay -->
    <div id="sideOverlay" class="sidebar-overlay"></div>

    <div class="layout">
        <aside id="sidebar">
            <div class="side-head">
                <div class="brand">Conversations</div>
                <div class="side-tools">
                    <button id="newChatSide" class="btn">New Chat</button>
                </div>
            </div>
            <div class="search"><input id="search" placeholder="Search titlesâ€¦" /><button id="clearSearch"
                    class="btn ghost" style="height:36px">Clear</button></div>
            <div class="recent-wrap">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <div class="recent-title">Recent Images</div>
                    <button id="clearRecentImages" class="btn danger" style="height:28px"
                        title="Clear all recent images on this device">Clear Recent</button>
                </div>
                <div id="imgGrid" class="imggrid"></div>
            </div>
            <div id="convos" class="convos"></div>
        </aside>
        <main id="main">
            <div class="card">
                <div class="head">
                    <div><span class="chip">Johnny Chat</span> <span class="chip">GPT-5</span></div>
                    <div style="display:flex;align-items:center;gap:12px;margin-left:auto">
                        <button id="newChatMain" class="btn" style="padding:6px 12px;font-size:0.85rem">New
                            Chat</button>
                    </div>
                </div>
                <div class="stack">
                    <section class="panel" style="padding:0">
                        <div class="chat">

                            <div id="messages" class="messages"></div>

                            <!-- Command Hint -->
                            <div id="cmdHint" class="command-hint">Type <code>/image</code> to generate art</div>

                            <!-- Attachment Preview -->
                            <div id="attachPreview" class="attachment-preview"></div>

                            <div class="composer">
                                <button id="btnAttach" class="attach-btn" title="Attach image or PDF">ğŸ“</button>
                                <textarea id="input"
                                    placeholder="Ask, visualize, or analyzeâ€¦ (Shift+Enter = newline)"></textarea>
                                <button id="send" class="btn">Send</button>
                                <input id="chatFiles" type="file" multiple accept=".pdf,image/png,image/jpeg"
                                    style="display:none" />
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <div id="fs" class="fs" aria-hidden="true"><button id="fsClose" class="close">âœ•</button><img id="fsImg" alt="" />
    </div>

    <div id="quota" class="quota" aria-hidden="true">
        <div class="quota-card">
            <div class="q-title">Daily image limit reached</div>
            <div class="q-badge">10 images / day</div>
            <div class="q-note">
                You've reached your daily limit of 10 images. Want more? Head to <strong>Image 1 Pro</strong> at the top
                of the page
                and subscribe for <strong>$10/month</strong> (40 generations). Priced close to raw model cost with a
                tiny hosting edge.
            </div>
            <div class="q-actions">
                <button id="quotaPro" class="btn">See Pro options</button>
                <button id="quotaClose" class="btn ghost">Maybe later</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            'use strict';
            var $ = function (id) { return document.getElementById(id) };
            document.querySelectorAll('.gen-overlay').forEach(function (n) { n.remove() });

            /* ---------- Endpoints ---------- */
            var API_BASE = "https://johnny-chat.onrender.com";
            var URLS = { CHAT: API_BASE + "/api/chat", BEAUTIFY: API_BASE + "/api/beautify", UPLOAD: API_BASE + "/upload", SUM: API_BASE + "/summarize-text", QUERY: API_BASE + "/query", GEN: API_BASE + "/generate-image", GEN_EDIT: API_BASE + "/generate-image-edit" };

            /* ---------- Utils ---------- */
            function escapeHTML(s) { return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") }
            function stripCites(s) { return String(s || "").replace(/\[[0-9]+\]/g, "").replace(/\((?:source|sources):.*?\)/gi, "") }
            function prettyHTML(t) {
                // 1. Parse Markdown (Bold, Italic, Links)
                var s = escapeHTML(t)
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

                // 2. Handle Text Blocks
                var L = s.split(/\r?\n/).map(function (l) { return l.trim() });
                var h = "", ul = false; function end() { if (ul) { h += "</ul>"; ul = false } }
                for (var i = 0; i < L.length; i++) {
                    var l = L[i]; if (!l) { end(); continue }
                    if (/^[-â€¢]\s+/.test(l)) { if (!ul) { h += "<ul>"; ul = true } h += "<li>" + l.replace(/^[-â€¢]\s+/, "") + "</li>"; }
                    else { end(); h += "<p>" + l + "</p>"; }
                }
                end(); return h || "<p></p>";
            }
            function autoResize(ta) { if (!ta) return; ta.style.height = "auto"; ta.style.height = (ta.scrollHeight + 2) + "px" }
            function uid() { return (crypto.randomUUID ? crypto.randomUUID() : ("id-" + Math.random().toString(36).slice(2))) }
            function nowISO() { return new Date().toISOString() }
            function safeParse(raw, fb) { try { var v = JSON.parse(raw); return (v === null ? fb : v) } catch (_) { return fb } }

            /* ---------- Image quota (10/day) ---------- */
            var QUOTA_KEY = "johnny_img_quota_v1", DAILY_LIMIT = 10;
            function today() { return new Date().toISOString().slice(0, 10) }
            function quotaRead() { var raw = localStorage.getItem(QUOTA_KEY), d = null; try { d = JSON.parse(raw) } catch (e) { } var t = today(); if (!d || d.date !== t) { d = { date: t, count: 0 }; localStorage.setItem(QUOTA_KEY, JSON.stringify(d)) } return d }
            function quotaCanGenerate() { return quotaRead().count < DAILY_LIMIT }
            function quotaInc() { var d = quotaRead(); d.count += 1; localStorage.setItem(QUOTA_KEY, JSON.stringify(d)) }
            function showQuota() { var q = $("quota"); q.classList.add("show"); q.setAttribute("aria-hidden", "false") }
            function hideQuota() { var q = $("quota"); q.classList.remove("show"); q.setAttribute("aria-hidden", "true") }
            $("quotaClose").addEventListener("click", hideQuota);
            $("quotaPro").addEventListener("click", function () { hideQuota(); window.scrollTo({ top: 0, behavior: "smooth" }); var pro = document.querySelector("[data-pro-button], #pro, #proButton"); if (pro) { pro.classList.add("pulse"); setTimeout(function () { pro.classList.remove("pulse") }, 1600) } });

            /* ---------- IndexedDB image cache ---------- */
            var dbPromise = null;
            function idbOpen() { if (!window.indexedDB) return Promise.resolve(null); if (dbPromise) return dbPromise; dbPromise = new Promise(function (res) { var r = indexedDB.open("johnny_images_db", 1); r.onupgradeneeded = function (e) { var db = e.target.result; if (!db.objectStoreNames.contains("images")) db.createObjectStore("images", { keyPath: "id" }) }; r.onsuccess = function () { res(r.result) }; r.onerror = function () { res(null) } }); return dbPromise }
            async function idbPut(img) { var db = await idbOpen(); if (!db) return; return new Promise(function (resolve) { var tx = db.transaction("images", "readwrite"); tx.objectStore("images").put(img); tx.oncomplete = function () { resolve() } }) }
            async function idbGetAll() { var db = await idbOpen(); if (!db) return []; return new Promise(function (resolve) { var tx = db.transaction("images", "readonly"); var req = tx.objectStore("images").getAll(); req.onsuccess = function () { resolve(req.result || []) }; req.onerror = function () { resolve([]) } }) }
            async function idbTrim(max) { var db = await idbOpen(); if (!db) return; var items = await idbGetAll(); items.sort(function (a, b) { return new Date(b.createdAt) - new Date(a.createdAt) }); if (items.length <= max) return; var toDelete = items.slice(max); await new Promise(function (resolve) { var tx = db.transaction("images", "readwrite"); var st = tx.objectStore("images"); toDelete.forEach(function (x) { st.delete(x.id) }); tx.oncomplete = function () { resolve() } }) }
            async function idbClear() { var db = await idbOpen(); if (!db) return; return new Promise(function (resolve) { var tx = db.transaction("images", "readwrite"); tx.objectStore("images").clear(); tx.oncomplete = function () { resolve() } }) }
            var imagesCache = [];
            async function loadImages() { var all = await idbGetAll(); all.sort(function (a, b) { return new Date(b.createdAt) - new Date(a.createdAt) }); imagesCache = all.slice(0, 300); renderImages() }
            function renderImages() { var grid = $("imgGrid"); grid.innerHTML = ""; imagesCache.forEach(function (it) { var im = document.createElement("img"); im.className = "mini"; im.src = it.url; im.addEventListener("click", function () { openFullscreen(it.url) }); grid.appendChild(im) }) }
            async function addImage(url) { await idbPut({ id: uid(), url, createdAt: nowISO() }); await idbTrim(300); await loadImages() }
            $("clearRecentImages").addEventListener("click", async function () { await idbClear(); imagesCache = []; renderImages() });

            /* ---------- Chat state ---------- */
            var STORE_KEY = "johnny_convos_v33";
            var convos = safeParse(localStorage.getItem(STORE_KEY) || "[]", []); if (!Array.isArray(convos)) convos = [];
            var activeId = localStorage.getItem("johnny_active_id") || "";
            var sessionContext = safeParse(localStorage.getItem("johnny_session_ctx") || "{}", {}); // {last_city:"St. Louis, MO"}

            function newConvo(t) { return { id: uid(), title: t || "(new conversation)", createdAt: nowISO(), updatedAt: nowISO(), messages: [], memory: "", memoryUpdatedAt: "", greeted: false } }
            function findConvo(id) { return (convos || []).find(function (c) { return c && c.id === id }) }
            function ensureActive() { if (activeId && findConvo(activeId)) return activeId; if (!convos.length) { convos.unshift(newConvo("(new conversation)")) } activeId = convos[0].id; localStorage.setItem("johnny_active_id", activeId); return activeId }
            function stripDisplayDeep(arr) { return (arr || []).map(function (c) { if (!c) return null; var cc = { id: c.id, title: c.title, createdAt: c.createdAt, updatedAt: c.updatedAt, messages: [], memory: c.memory || "", memoryUpdatedAt: c.memoryUpdatedAt || "", greeted: !!c.greeted }; (c.messages || []).forEach(function (m) { cc.messages.push({ role: m.role, content: m.content }) }); return cc }).filter(Boolean) }
            function tryStore(obj) { try { localStorage.setItem(STORE_KEY, JSON.stringify(obj)); return true } catch (_) { return false } }
            function saveConvos() {
                var sorted = (convos || []).filter(Boolean).slice().sort(function (a, b) { return new Date(b.updatedAt) - new Date(a.updatedAt) });
                var base = stripDisplayDeep(sorted); if (tryStore(base)) return;
                var keepMsgs = 120; while (keepMsgs >= 20) { var trimmed = base.map(function (c) { return Object.assign({}, c, { messages: c.messages.slice(-keepMsgs) }) }); if (tryStore(trimmed)) { convos = trimmed; return; } keepMsgs -= 20 }
                var limits = [30, 25, 20, 15, 10, 5, 3, 1]; for (var i = 0; i < limits.length; i++) { var limited = base.slice(0, limits[i]).map(function (c) { return Object.assign({}, c, { messages: c.messages.slice(-40) }) }); if (tryStore(limited)) { convos = limited; return; } }
                localStorage.removeItem(STORE_KEY); localStorage.setItem(STORE_KEY, "[]"); convos = [];
            }
            function saveSessionCtx() { localStorage.setItem("johnny_session_ctx", JSON.stringify(sessionContext || {})) }

            /* ---------- UI ---------- */
            var messagesEl = $("messages");
            function appendBubble(role, text) {
                var wrap = document.createElement("div"); var b = document.createElement("div");
                b.className = "bubble" + (role === "user" ? " user" : ""); wrap.appendChild(b);
                if (role === "user") { b.textContent = text }
                else {
                    b.dataset.raw = text; b.innerHTML = prettyHTML(stripCites(text));
                    var tip = document.createElement("div"); tip.className = "copy-tip"; tip.textContent = "Copied!";
                    var btn = document.createElement("button"); btn.className = "copy-btn"; btn.textContent = "â§‰";
                    btn.addEventListener("click", function () { navigator.clipboard.writeText(b.dataset.raw || b.textContent || "").then(function () { tip.style.display = "inline-block"; btn.textContent = "âœ“"; setTimeout(function () { tip.style.display = "none"; btn.textContent = "â§‰" }) }) });
                    b.appendChild(btn); b.appendChild(tip)
                }
                messagesEl.appendChild(wrap); messagesEl.scrollTop = messagesEl.scrollHeight
            }
            function showThinking() { var wrap = document.createElement("div"); var b = document.createElement("div"); b.className = "bubble"; b.innerHTML = '<div class="think"><div class="wave"><span></span><span></span><span></span></div><span>Thinkingâ€¦</span></div>'; wrap.appendChild(b); messagesEl.appendChild(wrap); messagesEl.scrollTop = messagesEl.scrollHeight; return { replace: function (txt) { b.dataset.raw = txt; b.innerHTML = prettyHTML(stripCites(txt)) }, container: wrap } }
            function setTitleIfPlaceholder(c, firstUserText) { if (!c) return; if (!c.title || c.title === "(new conversation)") { var t = String(firstUserText || "").trim().replace(/\s+/g, " ").slice(0, 60); c.title = t.length ? t : "(new conversation)" } }
            function transcriptText(c) { var lines = []; (c.messages || []).forEach(function (m) { lines.push((m.role || "assistant").toUpperCase() + ": " + String(m.content || "")) }); return lines.join("\n\n") }

            function renderSidebar() {
                var cont = $("convos"); cont.innerHTML = "";
                (convos || []).slice().sort(function (a, b) { return new Date(b.updatedAt) - new Date(a.updatedAt) }).forEach(function (c) {
                    if (!c) return; var row = document.createElement("div"); row.className = "row" + (c.id === activeId ? " active" : "");
                    var t = document.createElement("div"); t.className = "title"; t.textContent = c.title || "(new conversation)";
                    var keb = document.createElement("button"); keb.className = "kebab"; keb.textContent = "â‹¯";
                    var menu = document.createElement("div"); menu.className = "menu";
                    var dl = document.createElement("button"); dl.textContent = "Download transcript";
                    var del = document.createElement("button"); del.className = "danger"; del.textContent = "Delete conversation";
                    menu.appendChild(dl); menu.appendChild(del);
                    row.appendChild(t); row.appendChild(keb); row.appendChild(menu);
                    row.addEventListener("click", function (e) { if (e.target === keb || menu.contains(e.target)) return; activeId = c.id; localStorage.setItem("johnny_active_id", activeId); renderChat(); renderSidebar() });
                    keb.addEventListener("click", function (e) { e.stopPropagation(); document.querySelectorAll(".menu.show").forEach(function (m) { m.classList.remove("show") }); menu.classList.toggle("show") });
                    dl.addEventListener("click", function (e) { e.stopPropagation(); menu.classList.remove("show"); var txt = transcriptText(c); var blob = new Blob([txt], { type: "text/plain" }); var url = URL.createObjectURL(blob); var a = document.createElement("a"); a.href = url; a.download = (c.title || "conversation") + ".txt"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url) });
                    del.addEventListener("click", function (e) { e.stopPropagation(); menu.classList.remove("show"); convos = (convos || []).filter(function (x) { return x && x.id !== c.id }); if (activeId === c.id) { activeId = ""; ensureActive() } saveConvos(); renderSidebar(); renderChat() });
                    cont.appendChild(row);
                });
            }

            function renderChat() {
                messagesEl.innerHTML = "";
                var c = findConvo(ensureActive());
                if (!c || !Array.isArray(c.messages) || !c.messages.length) { initialGreeting(c); return }
                c.messages.forEach(function (m) { appendBubble(m.role, m.content || "") });
            }

            /* ---------- Memory (rolling) ---------- */
            async function maybeUpdateMemory(c) {
                try {
                    var msgCount = (c.messages || []).length;
                    var lastUpdate = c.memoryUpdatedAt ? new Date(c.memoryUpdatedAt).getTime() : 0;
                    var stale = Date.now() - lastUpdate > 1000 * 60 * 5;
                    if (msgCount >= 16 && stale) {
                        var recent = c.messages.slice(-60).map(function (m) { return (m.role || "assistant") + ": " + (m.content || "") }).join("\n");
                        var r = await fetch(URLS.SUM, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ text: recent, purpose: "conversation memory (compact facts, preferences, unresolved tasks)" }) });
                        var j = await r.json(); var memo = (j && j.summary ? String(j.summary) : "").slice(0, 1200);
                        if (memo) { c.memory = memo; c.memoryUpdatedAt = nowISO(); saveConvos(); }
                    }
                } catch (_) { }
            }

            /* ---------- City capture ---------- */
            function updateLastCityIfPresent(text) {
                var m = String(text || "").match(/\b(?:in|at|for)\s+([A-Za-z\s\.-]+?,\s*[A-Z]{2})\b/)
                    || String(text || "").match(/\b(?:in|at|for)\s+([A-Za-z\s\.-]+)\b/);
                if (m && m[1] && !/that city|this city/i.test(m[1])) {
                    sessionContext.last_city = m[1].trim(); saveSessionCtx();
                }
            }

            /* ---------- System/Directives ---------- */
            function buildSystemMessages(userText, c) {
                var t = String(userText || "");
                var wantsWeather = /\b(weather|forecast|temperature|temp|wind|humidity|conditions)\b/i.test(t);
                var currentish = /\b(current|right now|now|today|outside|this (?:morning|afternoon|evening)|tonight)\b/i.test(t);
                var msgs = [];
                msgs.push({
                    role: "system", content: [
                        "Policy:",
                        "â€¢ Ask at most ONE follow-up question only if essential to proceed. Otherwise answer directly.",
                        "â€¢ After that single follow-up (if any), answer decisively.",
                        "â€¢ IMPORTANT: If the user asks to generate/create/draw an image or picture, DO NOT generate ASCII art or SVG code.",
                        "â€¢ Instead, reply ONLY with the command: /image <detailed_prompt_describing_the_scene>",
                        "Weather defaults:",
                        "â€¢ Use America/Chicago timezone for any times you mention.",
                        "â€¢ Use imperial units (Â°F, mph) and never show Celsius unless explicitly requested.",
                        (wantsWeather && currentish ? "â€¢ If user asks for current weather today, add a short 1960s-weatherman style day report at the end." : "")
                    ].filter(Boolean).join("\n")
                });
                if (c && c.memory) { msgs.push({ role: "system", content: "Conversation memory (use to personalize; don't parrot):\n" + c.memory }); }
                if (sessionContext.last_city) { msgs.push({ role: "system", content: "Last referenced city this session: " + sessionContext.last_city }); }
                return msgs;
            }

            /* ---------- Mobile Sidebar Toggle ---------- */
            var hamburger = $("hamburger");
            var sideOverlay = $("sideOverlay");
            var sidebar = $("sidebar");

            function toggleSidebar() {
                hamburger.classList.toggle("active");
                sidebar.classList.toggle("open");
                sideOverlay.classList.toggle("show");
            }

            hamburger.addEventListener("click", toggleSidebar);
            sideOverlay.addEventListener("click", toggleSidebar);

            /* ---------- Chat Attachments & Commands ---------- */
            var btnAttach = $("btnAttach");
            var chatFiles = $("chatFiles");
            var attachPreview = $("attachPreview");
            var cmdHint = $("cmdHint");
            var pendingAttachments = [];

            btnAttach.addEventListener("click", function () { chatFiles.click() });

            chatFiles.addEventListener("change", function () {
                var files = Array.from(chatFiles.files || []);
                processChatUploads(files);
                chatFiles.value = ""; // reset
            });

            async function processChatUploads(files) {
                if (!files || !files.length) return;

                var c = findConvo(ensureActive());
                if (!c) return;

                // 1. User message placeholder (so it looks like a user action)
                var filenames = files.map(function (f) { return f.name }).join(", ");
                appendBubble("user", "[Uploaded: " + filenames + "]");
                c.messages.push({ role: "user", content: "Uploaded files: " + filenames });
                saveConvos();

                // 2. Assistant thinking bubble
                var thinking = showThinking();

                try {
                    var pdfTextParts = [];
                    var imgFiles = [];

                    for (var i = 0; i < files.length; i++) {
                        var f = files[i];
                        if (f.type === "application/pdf") {
                            var t = await extractPdfTextFile(f);
                            if (t) pdfTextParts.push(t);
                        } else if (f.type.startsWith("image/")) {
                            imgFiles.push(f);
                        }
                    }

                    var upText = "", upDesc = "";
                    if (imgFiles.length) {
                        var fd = new FormData();
                        for (var j = 0; j < imgFiles.length; j++) fd.append("files", imgFiles[j], imgFiles[j].name);

                        var r = await fetch(URLS.UPLOAD, { method: "POST", body: fd });
                        var jj = await r.json();
                        if (!r.ok) throw new Error(jj.detail || "Upload failed");

                        upText = jj.text || "";
                        upDesc = jj.description || "";
                    }

                    var combined = (pdfTextParts.join("\n\n") + "\n" + upText).trim();

                    // Summarize if significant content
                    var summary = "";
                    try {
                        if ((combined.length > 300) || upDesc.length > 50) {
                            var rs = await fetch(URLS.SUM, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ text: combined, description: upDesc }) });
                            var js = await rs.json();
                            summary = js.summary || "";
                        }
                    } catch (e) { console.error(e); }

                    // Construct Analysis Message
                    var finalMsg = "I've analyzed the uploaded content:\n\n";
                    if (summary) finalMsg += "**Executive Summary**\n" + summary + "\n\n";
                    if (upDesc) finalMsg += "**Visual Description**\n" + upDesc + "\n\n";

                    // If no summary/desc but text exists (e.g. short PDF or simple OCR)
                    if (!summary && !upDesc && combined) {
                        finalMsg += "**Extracted Content**\n" + combined.slice(0, 1500) + (combined.length > 1500 ? "..." : "");
                    }

                    if (!summary && !upDesc && !combined) finalMsg = "Processed files, but no text or visual content was extracted.";

                    // We append this as an assistant message. 
                    // CRITICAL: This puts the analysis into the conversation history, so the LLM can "see" it for subsequent questions.
                    appendAssistant(finalMsg, thinking, c);

                } catch (e) {
                    thinking.replace("Error processing upload: " + e.message);
                }
            }

            function renderAttachments() {
                attachPreview.innerHTML = "";
                if (!pendingAttachments.length) {
                    attachPreview.classList.remove("has-files");
                    return;
                }
                attachPreview.classList.add("has-files");

                pendingAttachments.forEach(function (f, idx) {
                    var item = document.createElement("div");
                    item.className = "attachment-item";

                    if (f.type.startsWith("image/")) {
                        var img = document.createElement("img");
                        img.src = URL.createObjectURL(f);
                        item.appendChild(img);
                    } else {
                        var icon = document.createElement("div");
                        icon.className = "pdf-icon";
                        icon.textContent = "PDF";
                        item.appendChild(icon);
                    }

                    var del = document.createElement("button");
                    del.className = "remove-attach";
                    del.textContent = "Ã—";
                    del.addEventListener("click", function () {
                        pendingAttachments.splice(idx, 1);
                        renderAttachments();
                    });
                    item.appendChild(del);

                    attachPreview.appendChild(item);
                });
            }

            // Command detection
            $("input").addEventListener("input", function (e) {
                var val = e.target.value.trim();
                if (val.startsWith("/")) {
                    if (val.startsWith("/image")) {
                        cmdHint.innerHTML = "Generating image: <strong>" + escapeHTML(val.slice(6).trim() || "...") + "</strong>";
                        cmdHint.classList.add("show");
                    } else {
                        cmdHint.classList.remove("show");
                    }
                } else {
                    cmdHint.classList.remove("show");
                }
            });

            /* ---------- Unified Send Message ---------- */

            // Shared image generation logic
            async function performImageGeneration(prompt, c, container) {
                // container is the div wrapper where we should show status/result
                container.innerHTML = '<div class="image-loader"><div class="loader-particles"><span></span><span></span><span></span><span></span><span></span></div><div class="neural-orb"></div><div class="loader-text">Generating Scene</div><div class="loader-subtext">Analyzing character & environment...</div></div>';
                messagesEl.scrollTop = messagesEl.scrollHeight;

                try {
                    if (!quotaCanGenerate()) {
                        container.innerHTML = '<div class="bubble">Daily image limit reached. Check top right for Pro.</div>';
                        showQuota();
                        return;
                    }

                    var r = await fetch(URLS.GEN, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: prompt, size: "1024x1024" }) });
                    var j = await r.json();

                    if (!r.ok) throw new Error(j.detail || "Generation failed");

                    var url = "data:image/png;base64," + j.image_b64;
                    addImage(url);
                    quotaInc();

                    container.innerHTML = '';
                    var imgBubble = document.createElement("img");
                    imgBubble.className = "bubble-image";
                    imgBubble.src = url;
                    imgBubble.onclick = function () { openFullscreen(url) };
                    container.appendChild(imgBubble);

                    // Add generic placeholder to history so we know an image was here
                    // (Note: we don't store the base64 in conversation history to save space)
                    if (!c.messages.some(function (m) { return m.content === "[Generated Image]" && m.role === "assistant" })) {
                        c.messages.push({ role: "assistant", content: "[Generated Image]" });
                        saveConvos();
                    }

                } catch (e) {
                    container.innerHTML = '<div class="bubble">Generation failed: ' + e.message + '</div>';
                }
            }

            async function sendMessage() {
                var inputDom = $("input");
                var txt = String(inputDom.value || "").trim();

                // 1. Handle Commands (Manual)
                if (txt.startsWith("/image ")) {
                    var prompt = txt.slice(7).trim();
                    if (!prompt) return;

                    inputDom.value = "";
                    cmdHint.classList.remove("show");

                    var c = findConvo(ensureActive());
                    if (!c) { c = newConvo("Image Generation"); convos.unshift(c); activeId = c.id; }

                    appendBubble("user", "/image " + prompt);
                    c.messages.push({ role: "user", content: "Generate image: " + prompt });
                    saveConvos();

                    var wrap = document.createElement("div");
                    messagesEl.appendChild(wrap);
                    performImageGeneration(prompt, c, wrap);
                    return;
                }

                if (!txt && !pendingAttachments.length) return;

                inputDom.value = "";
                updateLastCityIfPresent(txt);

                var c = findConvo(ensureActive());
                if (!c) { c = newConvo("(new conversation)"); convos.unshift(c); activeId = c.id }
                c.messages = Array.isArray(c.messages) ? c.messages : [];
                setTitleIfPlaceholder(c, txt);

                // 2. Handle Attachments
                var contextText = "";
                if (pendingAttachments.length) {
                    var attachMsg = "Attaching " + pendingAttachments.length + " file" + (pendingAttachments.length > 1 ? "s" : "") + "...";
                    appendBubble("user", txt ? txt + "\n\n(" + attachMsg + ")" : attachMsg);

                    var pdfTextParts = [];
                    var imgFiles = [];

                    for (var i = 0; i < pendingAttachments.length; i++) {
                        var f = pendingAttachments[i];
                        if (f.type === "application/pdf") {
                            var t = await extractPdfTextFile(f);
                            if (t) pdfTextParts.push(t);
                        } else if (f.type.startsWith("image/")) {
                            imgFiles.push(f);
                        }
                    }

                    var visionDesc = "";
                    if (imgFiles.length) {
                        var fd = new FormData();
                        for (var j = 0; j < imgFiles.length; j++) fd.append("files", imgFiles[j], imgFiles[j].name);
                        try {
                            var r = await fetch(URLS.UPLOAD, { method: "POST", body: fd });
                            var jj = await r.json();
                            if (r.ok) visionDesc = jj.description || "";
                        } catch (e) { console.error(e); }
                    }

                    contextText = (pdfTextParts.join("\n\n") + "\n" + visionDesc).trim();
                    c.messages.push({ role: "user", content: txt + "\n[System: User attached files. Analysis content: " + contextText.slice(0, 2000) + "]" });
                    pendingAttachments = [];
                    renderAttachments();
                } else {
                    appendBubble("user", txt);
                    c.messages.push({ role: "user", content: txt });
                }

                c.updatedAt = nowISO();
                saveConvos();
                renderSidebar();

                // 3. Normal Chat Flow
                var thinking = showThinking();
                // We want the last 20 messages, excluding the one we just added because we pass it as 'input' (with context)
                var hist = (c.messages || []).slice(0, -1).slice(-20).map(function (m) { return { role: m.role, content: m.content } });

                var sys = buildSystemMessages(txt, c);

                if (contextText) {
                    sys.push({ role: "system", content: "CRITICAL: The user has just attached a file. The following is the analysis of that file. You must answer the user's question based on THIS file analysis, ignoring any previous images or context if they conflict.\n\nFile Analysis:\n" + contextText });
                }

                var fullInput = txt;
                if (contextText) {
                    fullInput = "Reference this attached file analysis:\n" + contextText.slice(0, 3000) + "\n\nUser Question:\n" + (txt || "Describe this file");
                }

                var payload = {
                    input: fullInput || "Analyze these files",
                    history: [].concat(sys, hist),
                    directives: {
                        policy: { followups: "one_if_needed", max_followups: 1 },
                        weather: { timezone: "America/Chicago", units: "imperial", suppress_celsius: true, day_report_style_1960s: true }
                    },
                    context: { last_city: sessionContext.last_city || null }
                };

                maybeUpdateMemory(c);

                fetch(URLS.CHAT, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) })
                    .then(function (r) { return r.json() })
                    .then(function (j) {
                        var raw = j && j.reply ? j.reply : (j && j.detail ? ("Error: " + j.detail) : "(no reply)");
                        appendAssistant(raw, thinking, c);
                    })
                    .catch(function (e) { thinking.replace("Error: " + (e && e.message ? e.message : e)) });
            }

            function appendAssistant(raw, thinking, c) {
                // Intercept LLM commands
                if (raw.startsWith("/image ")) {
                    var prompt = raw.slice(7).trim();
                    // 'thinking' is the object { replace: fn, container: div }
                    // We need to verify showThinking provides 'container'

                    if (thinking.container) {
                        performImageGeneration(prompt, c, thinking.container);
                    } else {
                        // Fallback in case showThinking isn't updated properly yet
                        thinking.replace("Generating image: " + prompt);
                        var wrap = document.createElement("div");
                        messagesEl.appendChild(wrap);
                        performImageGeneration(prompt, c, wrap);
                    }
                    return;
                }

                thinking.replace(raw);
                c.messages.push({ role: "assistant", content: raw }); c.updatedAt = nowISO(); saveConvos(); renderSidebar();
                updateLastCityIfPresent(raw);
            }

            // ENTER to send (unless Shift+Enter)
            $("input").addEventListener("keydown", function (e) { if (e.isComposing) return; if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage() } });
            $("send").addEventListener("click", sendMessage);
            function triggerNewChat() { var c = newConvo("(new conversation)"); convos.unshift(c); activeId = c.id; renderSidebar(); renderChat(); if (window.innerWidth <= 768 && document.querySelector("#sidebar.open")) toggleSidebar(); }
            $("newChatSide").addEventListener("click", triggerNewChat);
            $("newChatMain").addEventListener("click", triggerNewChat);
            /* ---------- Initial greeting ---------- */
            function initialGreeting(c) {
                if (!c || c.greeted) return;
                c.greeted = true; saveConvos();
                var thinking = showThinking();
                var sys = buildSystemMessages("Greeting", c);
                fetch(URLS.CHAT, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ input: "[system_greet]", history: sys }) })
                    .then(function (r) { return r.json() })
                    .then(function (j) { var raw = j && j.reply ? j.reply : "Hello! How can I help today?"; appendAssistant(raw, thinking, c) })
                    .catch(function () { thinking.replace("Hello! How can I help today?") });
            }

            /* ---------- Docs & Image Analysis Utils ---------- */
            function extractPdfTextFile(file) { return new Promise(function (resolve) { file.arrayBuffer().then(function (buffer) { return pdfjsLib.getDocument({ data: buffer }).promise }).then(async function (doc) { let all = ""; for (let p = 1; p <= doc.numPages; p++) { const page = await doc.getPage(p); const content = await page.getTextContent(); const s = (content.items || []).map(function (it) { return it.str || "" }).join(" "); all += s + "\n" } resolve(all.trim()) }).catch(function () { resolve("") }) }) }

            /* ---------- Images ---------- */
            function openFullscreen(url) { $("fsImg").src = url; $("fs").classList.add("show"); $("fs").setAttribute("aria-hidden", "false") }
            $("fsClose").addEventListener("click", function () { $("fs").classList.remove("show"); $("fs").setAttribute("aria-hidden", "true") });

            /* ---------- Init ---------- */
            ensureActive(); renderSidebar(); loadImages(); renderChat();
        })();
    </script>
</body>

</html>